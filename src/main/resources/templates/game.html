<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${game.name} + ' - –ß–∞—Ç'">–ß–∞—Ç –∏–≥—Ä—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/chat.css}" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <div sec:authorize="isAuthenticated()">
            <a class="navbar-brand" href="/games">–ú–æ–∏ –∏–≥—Ä—ã</a>
        </div>
        <div class="ms-auto d-flex">
            <div sec:authorize="isAuthenticated()">
                    <span class="navbar-text me-2">
                        –ü—Ä–∏–≤–µ—Ç, <span sec:authentication="name"></span>!
                    </span>
                <form th:action="@{/logout}" method="post">
                    <button class="btn btn-outline-danger" type="submit">–í—ã–π—Ç–∏</button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <a class="btn btn-outline-primary me-2" th:href="@{/login}">–í–æ–π—Ç–∏</a>
                <a class="btn btn-primary" th:href="@{/register}">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar">
            <p><h4>–¢–µ–º–∞:</h4> <span th:text="${game.theme}"></span></p>
            <p><h4>–ò–≥—Ä–æ–∫–æ–≤:</h4> <span th:text="${game.players.size()}"></span>/<span
                th:text="${game.maxPlayers}"></span></p>

            <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>
            <ul>
                <li th:each="player : ${game.players}" th:text="${player.username}"></li>
            </ul>
        </div>

        <div class="col-md-9">
            <div class="container chat-container">
                <h2 class="text-center mb-4" th:text="${game.name}">–ß–∞—Ç –∏–≥—Ä—ã</h2>

                <div id="chat-messages">
                    <div th:each="message : ${messages}">
                        <div th:if="${message.isSpecial()}" class="dice-result text-center my-2 p-2 bg-light rounded">
                            <div class="message-text">
                                <strong th:text="${message.author.username + ' üé≤ ' + message.text}"></strong>
                            </div>
                        </div>
                        <div th:unless="${message.isSpecial}"
                             th:class="${message.author.id == currentUser.id} ? 'message my-message' : 'message other-message'">
                            <div class="message-author" th:text="${message.author.username}"></div>
                            <div class="message-text" th:text="${message.text}"></div>
                            <div class="message-time"
                                 th:text="${#temporals.format(message.timestamp, 'HH:mm dd.MM.yyyy')}"></div>
                        </div>
                    </div>
                </div>
                <form th:action="@{/games/{id}(id=${game.id})}" th:object="${newMessage}" method="post">
                    <input type="hidden" name="gameId" th:value="${game.id}">
                    <div class="input-group mb-3">
                        <button type="button" class="dice-btn" data-bs-toggle="modal" data-bs-target="#diceModal">
                            <img src="/images/dice.png" alt="–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫" width="30">
                        </button>
                        <input type="text" class="form-control" th:field="*{text}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                window.onload = function () {
                    const chat = document.getElementById('chat-messages');
                    chat.scrollTop = chat.scrollHeight;
                };
            </script>
        </div>
    </div>
</div>

<div class="modal fade" id="diceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–±–∏–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary dice-roll" data-sides="6">D6</button>
                <button class="btn btn-primary dice-roll" data-sides="8">D8</button>
                <button class="btn btn-primary dice-roll" data-sides="20">D20</button>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    const pathParts = window.location.pathname.split('/');
    const gameId = pathParts[2];

    document.addEventListener('DOMContentLoaded', function() {

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞
        document.querySelectorAll('.dice-roll').forEach(btn => {
            btn.addEventListener('click', async function() {
                const sides = this.getAttribute('data-sides');

                try {
                    const token = document.querySelector('meta[name="_csrf"]').content;
                    const header = document.querySelector('meta[name="_csrf_header"]').content;

                    const response = await fetch(`/games/${gameId}/roll-dice?sides=${sides}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [header]: token
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log("Server response:", data);

                    addDiceResultToChat(data.sides, data.result, data.user);

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const modal = bootstrap.Modal.getInstance(document.getElementById('diceModal'));
                    if (modal) modal.hide();

                } catch (error) {
                    console.error("Error rolling dice:", error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ—Å–∫–µ –∫—É–±–∏–∫–∞");
                }
            });
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —á–∞—Ç
        function addDiceResultToChat(sides, result, user) {
            const chatMessages = document.getElementById('chat-messages');
            const diceMessage = document.createElement('div');
            diceMessage.className = 'dice-result text-center my-2 p-2 bg-light rounded';
            diceMessage.innerHTML = `<strong>${user} üé≤ –í—ã–ø–∞–ª–æ: ${result} (d${sides})</strong>`;
            chatMessages.appendChild(diceMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
</body>
</html>